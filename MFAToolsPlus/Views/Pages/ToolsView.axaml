<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:suki="https://github.com/kikipoulet/SukiUI"
             xmlns:markup="https://codewf.com"
             x:DataType="pages:ToolsViewModel"
             xmlns:helper="clr-namespace:MFAToolsPlus.Helper"
             xmlns:ex="clr-namespace:MFAToolsPlus.Extensions"
             xmlns:calcBinding="clr-namespace:CalcBinding;assembly=CalcBindingAva"
             xmlns:pages="clr-namespace:MFAToolsPlus.ViewModels.Pages"
             xmlns:maa="clr-namespace:MFAToolsPlus.Extensions.MaaFW"
             xmlns:avalonia="clr-namespace:FluentIcons.Avalonia;assembly=FluentIcons.Avalonia"
             xmlns:binding="clr-namespace:MaaFramework.Binding;assembly=MaaFramework.Binding"
             xmlns:converters="clr-namespace:MFAToolsPlus.Helper.Converters"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="MFAToolsPlus.Views.Pages.ToolsView">
    <Design.DataContext>
        <pages:ToolsViewModel />
    </Design.DataContext>
    <UserControl.Styles>
        <Style Selector="Button.SyncButton Path">
            <Setter Property="RenderTransformOrigin" Value="50%,50%" />
            <Setter Property="Margin" Value="1" />
            <Setter Property="RenderTransform">
                <Setter.Value>
                    <TransformGroup>
                        <ScaleTransform ScaleX="1" ScaleY="1" />
                        <RotateTransform Angle="0" />
                    </TransformGroup>
                </Setter.Value>
            </Setter>
        </Style>
        <Style Selector="Button.SyncButton:pointerover Path">
            <Style.Animations>
                <Animation Duration="0:0:0.15" FillMode="Forward">
                    <KeyFrame Cue="100%">
                        <Setter Property="ScaleTransform.ScaleX" Value="1.1" />
                        <Setter Property="ScaleTransform.ScaleY" Value="1.1" />
                        <Setter Property="RotateTransform.Angle" Value="-15" />
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>
        <Style Selector="Button.SyncButton:not(:pointerover) Path">
            <Style.Animations>
                <Animation Duration="0:0:0.15" FillMode="Forward">
                    <KeyFrame Cue="100%">
                        <Setter Property="ScaleTransform.ScaleX" Value="1" />
                        <Setter Property="ScaleTransform.ScaleY" Value="1" />
                        <Setter Property="RotateTransform.Angle" Value="0" />
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>
        <Style Selector="Button.SyncButton:pressed Path">
            <Style.Animations>
                <Animation Duration="0:0:0.6" FillMode="Forward">
                    <KeyFrame Cue="0%">
                        <Setter Property="RotateTransform.Angle" Value="0" />
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                        <Setter Property="RotateTransform.Angle" Value="360" />
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>


        <!-- 中心绿点脉冲动画 -->
        <Style Selector="Ellipse#LiveStatusDot">
            <Style.Animations>
                <Animation Duration="0:0:1.5" IterationCount="INFINITE" Easing="CubicEaseInOut">
                    <KeyFrame Cue="0%">
                        <Setter Property="ScaleTransform.ScaleX" Value="1" />
                        <Setter Property="ScaleTransform.ScaleY" Value="1" />
                        <Setter Property="Opacity" Value="1" />
                    </KeyFrame>
                    <KeyFrame Cue="50%">
                        <Setter Property="ScaleTransform.ScaleX" Value="1.2" />
                        <Setter Property="ScaleTransform.ScaleY" Value="1.2" />
                        <Setter Property="Opacity" Value="0.8" />
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                        <Setter Property="ScaleTransform.ScaleX" Value="1" />
                        <Setter Property="ScaleTransform.ScaleY" Value="1" />
                        <Setter Property="Opacity" Value="1" />
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>

        <!-- 外圈扩散动画 1 -->
        <Style Selector="Ellipse#PulseRing1">
            <Style.Animations>
                <Animation Duration="0:0:1.5" IterationCount="INFINITE" Easing="CubicEaseOut">
                    <KeyFrame Cue="0%">
                        <Setter Property="ScaleTransform.ScaleX" Value="1" />
                        <Setter Property="ScaleTransform.ScaleY" Value="1" />
                        <Setter Property="Opacity" Value="0.6" />
                        <Setter Property="StrokeThickness" Value="2" />
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                        <Setter Property="ScaleTransform.ScaleX" Value="2.5" />
                        <Setter Property="ScaleTransform.ScaleY" Value="2.5" />
                        <Setter Property="Opacity" Value="0" />
                        <Setter Property="StrokeThickness" Value="0.5" />
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>

        <!-- 外圈扩散动画 2 (延迟 0.75s) -->
        <Style Selector="Ellipse#PulseRing2">
            <Style.Animations>
                <Animation Duration="0:0:1.5" IterationCount="INFINITE" Easing="CubicEaseOut" Delay="0:0:0.75">
                    <KeyFrame Cue="0%">
                        <Setter Property="ScaleTransform.ScaleX" Value="1" />
                        <Setter Property="ScaleTransform.ScaleY" Value="1" />
                        <Setter Property="Opacity" Value="0.6" />
                        <Setter Property="StrokeThickness" Value="2" />
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                        <Setter Property="ScaleTransform.ScaleX" Value="2.5" />
                        <Setter Property="ScaleTransform.ScaleY" Value="2.5" />
                        <Setter Property="Opacity" Value="0" />
                        <Setter Property="StrokeThickness" Value="0.5" />
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>


        <!-- TaskToggle 外层悬停放大 -->
        <Style Selector="Border#TaskToggleBorder">
            <Setter Property="RenderTransformOrigin" Value="50%,50%" />
            <Setter Property="RenderTransform">
                <Setter.Value>
                    <ScaleTransform ScaleX="1" ScaleY="1" />
                </Setter.Value>
            </Setter>
        </Style>
        <Style Selector="Border#TaskToggleBorder:pointerover">
            <Setter Property="RenderTransform">
                <ScaleTransform ScaleX="1.12" ScaleY="1.12" />
            </Setter>
            <Setter Property="Background" Value="{DynamicResource SukiPrimaryColor75}" />
        </Style>

        <!-- 单层流光动画 -->
        <Style Selector="Border#TaskToggleShineLayer">
            <Setter Property="RenderTransform">
                <Setter.Value>
                    <TranslateTransform X="-160" />
                </Setter.Value>
            </Setter>
            <Style.Animations>
                <Animation Duration="0:0:1.8" IterationCount="INFINITE">
                    <KeyFrame Cue="0%">
                        <Setter Property="TranslateTransform.X" Value="-160" />
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                        <Setter Property="TranslateTransform.X" Value="160" />
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>

        <!-- BasicTight 悬停放大与前景变浅 -->
        <Style Selector="Button.TaskQueueBasicTight">
            <Setter Property="RenderTransformOrigin" Value="50%,50%" />
            <Setter Property="RenderTransform">
                <Setter.Value>
                    <ScaleTransform ScaleX="1" ScaleY="1" />
                </Setter.Value>
            </Setter>
        </Style>

        <Style Selector="Button.TaskQueueBasicTight:pointerover">
            <Setter Property="RenderTransform">
                <ScaleTransform ScaleX="1.2" ScaleY="1.2" />
            </Setter>
            <Setter Property="Foreground" Value="{DynamicResource SukiPrimaryColor75}" />
        </Style>

        <Style Selector="Button.PlayStopButton:pointerover">
            <Style.Animations>
                <Animation Duration="0:0:0.15" FillMode="Forward">
                    <KeyFrame Cue="100%">
                        <Setter Property="ScaleTransform.ScaleX" Value="1.15" />
                        <Setter Property="ScaleTransform.ScaleY" Value="1.15" />
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>

        <Style Selector="Button.PlayStopButton:not(:pointerover)">
            <Style.Animations>
                <Animation Duration="0:0:0.15" FillMode="Forward">
                    <KeyFrame Cue="100%">
                        <Setter Property="ScaleTransform.ScaleX" Value="1" />
                        <Setter Property="ScaleTransform.ScaleY" Value="1" />
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>

        <Style Selector="Border#GradientButtonBorder:pointerover Border#ShineLayer1">
            <Setter Property="Background">
                <Setter.Value>
                    <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,100%">
                        <GradientStop Color="Transparent" Offset="0.0" />
                        <GradientStop Color="Transparent" Offset="0.25" />
                        <GradientStop Color="#40FFFFFF" Offset="0.45" />
                        <GradientStop Color="#70FFFFFF" Offset="0.5" />
                        <GradientStop Color="#40FFFFFF" Offset="0.55" />
                        <GradientStop Color="Transparent" Offset="0.75" />
                        <GradientStop Color="Transparent" Offset="1.0" />
                    </LinearGradientBrush>
                </Setter.Value>
            </Setter>
        </Style>
        <Style Selector="Border#GradientButtonBorder:pointerover Border#ShineLayer2">
            <Setter Property="Background">
                <Setter.Value>
                    <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,100%">
                        <GradientStop Color="Transparent" Offset="0.0" />
                        <GradientStop Color="Transparent" Offset="0.25" />
                        <GradientStop Color="#40FFFFFF" Offset="0.45" />
                        <GradientStop Color="#70FFFFFF" Offset="0.5" />
                        <GradientStop Color="#40FFFFFF" Offset="0.55" />
                        <GradientStop Color="Transparent" Offset="0.75" />
                        <GradientStop Color="Transparent" Offset="1.0" />
                    </LinearGradientBrush>
                </Setter.Value>
            </Setter>
        </Style>
        <Style Selector="Border#GradientButtonBorder:pointerover Border#ShineLayer3">
            <Setter Property="Background">
                <Setter.Value>
                    <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,100%">
                        <GradientStop Color="Transparent" Offset="0.0" />
                        <GradientStop Color="Transparent" Offset="0.25" />
                        <GradientStop Color="#40FFFFFF" Offset="0.45" />
                        <GradientStop Color="#70FFFFFF" Offset="0.5" />
                        <GradientStop Color="#40FFFFFF" Offset="0.55" />
                        <GradientStop Color="Transparent" Offset="0.75" />
                        <GradientStop Color="Transparent" Offset="1.0" />
                    </LinearGradientBrush>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Styles>
    <Grid ClipToBounds="False" Margin="0,0,0,0" RowDefinitions="Auto,*" x:Name="MainGrid">

        <!-- 第一行：顶部工具栏（资源选择 + 连接设置） -->
        <suki:GlassCard Grid.Row="0" Margin="15,15,15,5" Padding="12,8" IsAnimated="False">
            <Grid x:Name="TopToolbar">
                <Grid x:Name="TopToolbarWide">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <!-- 控制器类型选择 -->
                    <Grid x:Name="ControllerSelectorPanel" Grid.Column="0" VerticalAlignment="Center"
                          ColumnDefinitions="Auto,*">
                        <TextBlock Grid.Column="0" FontSize="12"
                                   FontWeight="Bold" Foreground="{DynamicResource SukiLowText}"
                                   Text="{markup:I18n {x:Static helper:LangKeys.ControllerType}}"
                                   VerticalAlignment="Center" />
                        <ComboBox Margin="8 0 0 0" Grid.Column="1" x:Name="ControllerComboBox"
                                  ex:ComboBoxExtensions.DisableNavigationOnLostFocus="True"
                                  IsEnabled="{calcBinding:Binding '!LockController and Idle',Source={x:Static helper:Instances.RootViewModel}}"
                                  ItemsSource="{Binding ControllerOptions}"
                                  SelectedItem="{Binding SelectedController, Mode=TwoWay}"
                                  MinWidth="120" VerticalAlignment="Center">
                            <ComboBox.ItemTemplate>
                                <DataTemplate x:DataType="maa:MaaInterface+MaaResourceController">
        
                                        <TextBlock Background="Transparent" Foreground="{DynamicResource SukiText}"
                       
                                                   Text="{Binding DisplayName}"
                                                   TextTrimming="CharacterEllipsis"
                                                   VerticalAlignment="Center" />
                       
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                            <ComboBox.SelectionBoxItemTemplate>
                                <DataTemplate>
                                        <TextBlock Background="Transparent" Foreground="{DynamicResource SukiText}"
                                                   Text="{Binding DisplayName}"
                                                   TextTrimming="CharacterEllipsis"
                                                   VerticalAlignment="Center" />
                               
                                </DataTemplate>
                            </ComboBox.SelectionBoxItemTemplate>
                        </ComboBox>
                    </Grid>
                    <!-- 右侧：连接设置 -->
                    <Grid x:Name="DeviceSelectorPanel" Grid.Column="1" HorizontalAlignment="Stretch"
                          MinWidth="200"
                          IsVisible="{calcBinding:Binding 'CurrentController != maa:MaaControllerTypes.PlayCover'}">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" x:Name="DeviceSelectorLabel"
                                   FontSize="12" Margin="8 0"
                                   FontWeight="Bold" Foreground="{DynamicResource SukiLowText}"
                                   Text="{markup:I18n {x:Static helper:LangKeys.CurrentController}}"
                                   VerticalAlignment="Center" />
                        <ComboBox Grid.Column="1" x:Name="DeviceComboBox"
                                  ex:ComboBoxExtensions.DisableNavigationOnLostFocus="True"
                                  Classes="LimitWidth" Height="35"
                                  IsEnabled="{Binding Idle, Source={x:Static helper:Instances.RootViewModel}}"
                                  ItemsSource="{Binding Devices}"
                                  MinWidth="100"
                                  HorizontalAlignment="Stretch"
                                  SelectedValue="{Binding CurrentDevice, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                            <ToolTip.Tip>
                                <TextBlock
                                    Text="{Binding CurrentDevice, Converter={converters:DeviceDisplayConverter}}" />
                            </ToolTip.Tip>
                            <ComboBox.DataTemplates>
                                <DataTemplate DataType="binding:AdbDeviceInfo">
                                    <TextBlock HorizontalAlignment="Left"
                                               Text="{Binding Converter={converters:DeviceDisplayConverter}}" />
                                </DataTemplate>
                                <DataTemplate DataType="binding:DesktopWindowInfo">
                                    <TextBlock HorizontalAlignment="Left"
                                               Text="{Binding Name}" />
                                </DataTemplate>
                            </ComboBox.DataTemplates>
                        </ComboBox>
                    </Grid>
                    <StackPanel x:Name="ConnectionButtonsPanel" Grid.Column="2" Orientation="Horizontal"
                                VerticalAlignment="Center" Spacing="4">
                        <StackPanel.Resources>
                            <markup:IfConditionConverter x:Key="ConnectedConditionConverter">
                                <markup:IfConditionConverter.True>
                                    <Path Data="{StaticResource ConnectedGeometry}" Fill="LimeGreen"
                                          Height="11" Margin="3,2,4,0" Stretch="Uniform"
                                          ToolTip.Tip="{markup:I18n {x:Static helper:LangKeys.Connected}}" />
                                </markup:IfConditionConverter.True>
                                <markup:IfConditionConverter.False>
                                    <Path Data="{StaticResource UnconnectedGeometry}" Fill="Red"
                                          Height="16" Margin="3,3,4,0" Stretch="Uniform"
                                          ToolTip.Tip="{markup:I18n {x:Static helper:LangKeys.Unconnected}}"
                                          VerticalAlignment="Center" />
                                </markup:IfConditionConverter.False>
                            </markup:IfConditionConverter>
                        </StackPanel.Resources>
                        <Button Classes="BasicTight TaskQueueBasicTight"
                                ClipToBounds="False"
                                Command="{Binding CustomAdbCommand}"
                                IsEnabled="{Binding Idle, Source={x:Static helper:Instances.RootViewModel}}"
                                IsVisible="{calcBinding:Binding 'CurrentController == maa:MaaControllerTypes.Adb'}"
                                Padding="0" ToolTip.Tip="{markup:I18n {x:Static helper:LangKeys.Custom}}">
                            <avalonia:FluentIcon Height="18" Icon="DesktopEdit" IconSize="Size16"
                                                  IconVariant="Regular" />
                        </Button>
                        <Button Classes="BasicTight TaskQueueBasicTight"
                                Command="{Binding EditPlayCoverCommand}"
                                IsEnabled="{Binding Idle, Source={x:Static helper:Instances.RootViewModel}}"
                                IsVisible="{calcBinding:Binding 'CurrentController == maa:MaaControllerTypes.PlayCover'}"
                                Padding="0"
                                ToolTip.Tip="{markup:I18n {x:Static helper:LangKeys.EditControllerConfiguration}}">
                            <avalonia:FluentIcon Height="18" Icon="DesktopEdit" IconSize="Size16"
                                                  IconVariant="Regular" />
                        </Button>
                        <Button Classes="BasicTight TaskQueueBasicTight"
                                Command="{Binding ReconnectCommand}"
                                IsEnabled="{Binding Idle, Source={x:Static helper:Instances.RootViewModel}}"
                                Padding="0"
                                Width="24"
                                Height="24"
                                HorizontalContentAlignment="Center"
                                VerticalContentAlignment="Center"
                                ToolTip.Tip="{markup:I18n {x:Static helper:LangKeys.Reconnect}}"
                                VerticalAlignment="Center">
                            <Path Data="{StaticResource LinkGeometry}"
                                  Width="16"
                                  Height="16"
                                  Stretch="Uniform"
                                  Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" />
                        </Button>
                        <Button Classes="BasicTight TaskQueueBasicTight SyncButton"
                                ClipToBounds="False"
                                Command="{Binding RefreshCommand}"
                                IsEnabled="{Binding Idle, Source={x:Static helper:Instances.RootViewModel}}"
                                Padding="0"
                                Width="24"
                                IsVisible="{calcBinding:Binding 'CurrentController != maa:MaaControllerTypes.PlayCover'}"
                                Height="24"
                                HorizontalContentAlignment="Center"
                                VerticalContentAlignment="Center"
                                ToolTip.Tip="{markup:I18n {x:Static helper:LangKeys.TooltipRefresh}}"
                                VerticalAlignment="Center">
                            <Path Data="{StaticResource RefreshGeometry}"
                                  Width="16"
                                  Height="16"
                                  Stretch="Uniform"
                                  Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" />
                        </Button>
                        <ContentControl
                            Content="{Binding IsConnected, Converter={StaticResource ConnectedConditionConverter}, Source={x:Static helper:Instances.ToolsViewModel}}" />
                    </StackPanel>
                </Grid>
            </Grid>
        </suki:GlassCard>

        <Grid Grid.Row="1" Margin="15,5,15,15">
            <suki:GlassCard  x:Name="LiveViewCard">
                <suki:GroupBox>
                    <suki:GroupBox.Header>
                        <TextBlock FontSize="11"
                                   FontWeight="Bold"
                                   Foreground="{DynamicResource SukiLowText}"
                                   Margin="2,0,0,0"
                                   Text="{markup:I18n {x:Static helper:LangKeys.LiveView}}"
                                   VerticalAlignment="Center" />
                    </suki:GroupBox.Header>
                    <Border x:Name="LiveViewFrame"
                            ClipToBounds="True"
                            Background="Transparent"
                            BorderBrush="{DynamicResource SukiControlBorderBrush}"
                            BorderThickness="0"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center">
                        <Border CornerRadius="0" ClipToBounds="True">
                            <Image
                                Source="{Binding LiveViewImage}"
                                IsVisible="{Binding LiveViewImage, Converter={x:Static ObjectConverters.IsNotNull}}"
                                Stretch="Uniform"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center" />
                        </Border>
                    </Border>
                </suki:GroupBox>
            </suki:GlassCard>
        </Grid>
    </Grid>
</UserControl>